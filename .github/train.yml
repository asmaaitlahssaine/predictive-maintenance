# .github/workflows/train.yml
name: Auto-Train ML Model

on:
  # Trigger sur push de code
  push:
    branches: [ main, develop ]
    paths:
      - 'scripts/**'
      - 'data/raw/*.csv'
  
  # Trigger manuel depuis GitHub UI
  workflow_dispatch:
  
  # Trigger programmÃ© (optionnel - tous les lundis Ã  2h)
  schedule:
    - cron: '0 2 * * 1'

jobs:
  train:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ğŸ Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: ğŸ“¦ Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: ğŸ”§ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ“Š Create sample data (for demo)
      run: |
        mkdir -p data/raw
        # Si tu n'as pas de donnÃ©es, ce script crÃ©e un sample
        python -c "
        import pandas as pd
        import numpy as np
        np.random.seed(42)
        data = {
            'Engine rpm': np.random.randint(1000, 5000, 1000),
            'Lub oil pressure': np.random.randint(30, 70, 1000),
            'Coolant temp': np.random.randint(70, 110, 1000),
            'lub oil temp': np.random.randint(60, 100, 1000),
            'Engine Condition': np.random.choice([0, 1], 1000, p=[0.7, 0.3])
        }
        df = pd.DataFrame(data)
        df.to_csv('data/raw/engine_data.csv', index=False)
        print('âœ… Sample data created')
        "
    
    - name: ğŸ”„ Run preprocessing
      run: |
        python scripts/preprocess.py \
          --input data/raw/engine_data.csv \
          --output data/processed/processed.csv
    
    - name: ğŸ¤– Train models
      run: |
        python scripts/train.py \
          --input data/processed/processed.csv \
          --target "Engine Condition"
    
    - name: âœ… Check model performance
      run: |
        python scripts/check_performance.py --threshold 0.80
    
    - name: ğŸ’¾ Upload model artifact
      uses: actions/upload-artifact@v3
      with:
        name: trained-model
        path: models/best_model.joblib
        retention-days: 30
    
    - name: ğŸ“Š Upload MLflow runs
      uses: actions/upload-artifact@v3
      with:
        name: mlflow-tracking
        path: mlruns/
        retention-days: 30
    
    - name: ğŸ“ˆ Upload training report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: training-report
        path: reports/last_training.json
        retention-days: 30
    
    - name: ğŸ‰ Success notification
      if: success()
      run: |
        echo "âœ… Model training completed successfully!"
        echo "ğŸ“Š Check the artifacts tab for results"